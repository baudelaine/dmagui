<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>dd tool</title>
	<link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-table.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-editable.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-select.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-theme.min.css" type="text/css" rel="stylesheet" />
	<!-- <link href="css/test0.css" type="text/css" rel="stylesheet" /> -->

</head>
<body>

			<div class="container">
	        <h1>Sub Table</h1>
	        <p>Use <code>onExpandRow</code> event to handle your detail view.</p>
	        <table id="table">
	        </table>
	    </div>



	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-table.min.js"></script>

	<script>

			var data0 = [
			 {
			  "_id": "DEPTFinalDEPT",
			  "_ref": null,
			  "fields": [
			   {
			    "field_name": "DEPTNO",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "DEPTNAME",
			    "field_type": "VARCHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "MGRNO",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "ADMRDEPT",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "LOCATION",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   }
			  ],
			  "filter": "",
			  "label": "",
			  "table_alias": "DEPT",
			  "table_name": "DEPT",
			  "type": "Final",
			  "visible": false
			 },
			 {
			  "_id": "EMPLOYEEFinalEMPLOYEE",
			  "_ref": null,
			  "fields": [
			   {
			    "field_name": "EMPNO",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "FIRSTNME",
			    "field_type": "VARCHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "MIDINIT",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "LASTNAME",
			    "field_type": "VARCHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "WORKDEPT",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "PHONENO",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "HIREDATE",
			    "field_type": "DATE",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "JOB",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "EDLEVEL",
			    "field_type": "SMALLINT",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "SEX",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "BIRTHDATE",
			    "field_type": "DATE",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "SALARY",
			    "field_type": "DECIMAL",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "BONUS",
			    "field_type": "DECIMAL",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "COMM",
			    "field_type": "DECIMAL",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   }
			  ],
			  "filter": "",
			  "label": "",
			  "table_alias": "EMPLOYEE",
			  "table_name": "EMPLOYEE",
			  "type": "Final",
			  "visible": false
			 },
			 {
			  "_id": "PROJECTFinalPROJECT",
			  "_ref": null,
			  "fields": [
			   {
			    "field_name": "PROJNO",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "PROJNAME",
			    "field_type": "VARCHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "DEPTNO",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "RESPEMP",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "PRSTAFF",
			    "field_type": "DECIMAL",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "PRSTDATE",
			    "field_type": "DATE",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "PRENDATE",
			    "field_type": "DATE",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   },
			   {
			    "field_name": "MAJPROJ",
			    "field_type": "CHAR",
			    "icon": "",
			    "label": "",
			    "timezone": false,
			    "traduction": false,
			    "visibleField": false
			   }
			  ],
			  "filter": "",
			  "label": "",
			  "table_alias": "PROJECT",
			  "table_name": "PROJECT",
			  "type": "Final",
			  "visible": false
			 }
			]

			var data = [
			  {
			    "_id": "PROJECT_ALIASFinalqqq",
			    "_ref": null,
			    "table_name": "PROJECT",
			    "table_alias": "PROJECT_ALIAS",
			    "type": "Final",
			    "visible": false,
			    "filter": "",
			    "linker": false,
			    "linker_ids": [],
			    "fields": [
			      {
			        "_id": "PROJNOCHAR",
			        "_ref": null,
			        "field_name": "PROJNO",
			        "field_type": "CHAR",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "PROJNAMEVARCHAR",
			        "_ref": null,
			        "field_name": "PROJNAME",
			        "field_type": "VARCHAR",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "DEPTNOCHAR",
			        "_ref": null,
			        "field_name": "DEPTNO",
			        "field_type": "CHAR",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "RESPEMPCHAR",
			        "_ref": null,
			        "field_name": "RESPEMP",
			        "field_type": "CHAR",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "PRSTAFFDECIMAL",
			        "_ref": null,
			        "field_name": "PRSTAFF",
			        "field_type": "DECIMAL",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "PRSTDATEDATE",
			        "_ref": null,
			        "field_name": "PRSTDATE",
			        "field_type": "DATE",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "PRENDATEDATE",
			        "_ref": null,
			        "field_name": "PRENDATE",
			        "field_type": "DATE",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      },
			      {
			        "_id": "MAJPROJCHAR",
			        "_ref": null,
			        "field_name": "MAJPROJ",
			        "field_type": "CHAR",
			        "label": "",
			        "traduction": false,
			        "visible": false,
			        "timezone": false,
			        "icon": ""
			      }
			    ],
			    "relations": [
			      {
			        "_id": "RPPF",
			        "_rev": null,
			        "key_name": "RPP",
			        "fk_name": "RPP",
			        "pk_name": "PK_PROJECT",
			        "table_name": "PROJECT",
			        "pktable_name": "PROJ",
			        "pktable_alias": "PROJ",
			        "fin": false,
			        "ref": false,
			        "relashionship": "[FINAL].[PROJECT_ALIAS].[MAJPROJ] = [PROJ].[PROJNO] AND [FINAL].[PROJECT_ALIAS].[MAJPROJ] = [PROJECT].[PROJNO]",
			        "key_type": "F",
							"above": "MAJPROJ",
							// "above": "ggggggggggggg",
			        "seqs": [
			          {
			            "column_name": "MAJPROJ",
			            "pkcolumn_name": "PROJNO",
			            "key_seq": 1
			          },
			          {
			            "column_name": "MAJPROJAA",
			            "pkcolumn_name": "PROJNO",
			            "key_seq": 2
			          }
			        ]
			      },
			      {
			        "_id": "FK_PROJECT_2F",
			        "_rev": null,
			        "key_name": "FK_PROJECT_2",
			        "fk_name": "FK_PROJECT_2",
			        "pk_name": "PK_EMPLOYEE",
			        "table_name": "PROJECT",
			        "pktable_name": "EMP",
			        "pktable_alias": "EMP",
			        "fin": false,
			        "ref": false,
			        "relashionship": "[FINAL].[PROJECT_ALIAS].[RESPEMP] = [EMP].[EMPNO] AND [FINAL].[PROJECT_ALIAS].[RESPEMP] = [EMPLOYEE].[EMPNO]",
			        "key_type": "F",
							"above": "RESPEMP",
							// "above": "qscvqcqcqc",
			        "seqs": [
			          {
			            "column_name": "RESPEMP",
			            "pkcolumn_name": "EMPNO",
			            "key_seq": 1
			          },
			          {
			            "column_name": "RESPEMPAA",
			            "pkcolumn_name": "EMPNO",
			            "key_seq": 2
			          }
			        ]
			      },
			      {
			        "_id": "FK_PROJECT_1F",
			        "_rev": null,
			        "key_name": "FK_PROJECT_1",
			        "fk_name": "FK_PROJECT_1",
			        "pk_name": "PK_DEPARTMENT",
			        "table_name": "PROJECT",
			        "pktable_name": "DEPARTMENT",
			        "pktable_alias": "DEPARTMENT",
			        "fin": false,
			        "ref": false,
			        "relashionship": "[FINAL].[PROJECT_ALIAS].[DEPTNO] = [DEPARTMENT].[DEPTNO] AND [FINAL].[PROJECT_ALIAS].[DEPTNO] = [DEPT].[DEPTNO]",
			        "key_type": "F",
							"above": "DEPTNO",
							// "above": ",h,yu,yu,ytu,ty,",
			        "seqs": [
			          {
			            "column_name": "DEPTNO",
			            "pkcolumn_name": "DEPTNO",
			            "key_seq": 1
			          },
			          {
			            "column_name": "DEPTNOAA",
			            "pkcolumn_name": "DEPTNO",
			            "key_seq": 2
			          }
			        ]
			      }
			    ],
			    "relationCount": {},
			    "label": ""
			  }
			]

			var $table = $('#table');
			var url = "js/QuerySubjects.json";

			var cols = [];
			cols.push({field:"checkbox", checkbox: "true"});
			cols.push({field:"index", title: "index", formatter: "indexFormatter", sortable: false});
			cols.push({field:"_id", title: "_id", sortable: false});
			cols.push({field:"table_name", title: "table_name", sortable: false });
			cols.push({field:"table_alias", title: "table_alias", editable: false, sortable: false});
			cols.push({field:"type", title: "type", sortable: false});
			cols.push({field:"visible", title: "visible", formatter: "boolFormatter", sortable: false});
			cols.push({field:"filter", title: "filter", editable: {type: "textarea", mode: "inline"}, sortable: false});
			cols.push({field:"label", title: "label", editable: {type: "textarea", mode: "inline"}});

			var subcols = [];
			subcols.push({field:"subindex", title: "subindex", formatter: "indexFormatter", sortable: false});
			subcols.push({field:"field_name", title: "field_name", sortable: false });
			subcols.push({field:"label", title: "label", editable: {type: "text", mode: "inline"}, sortable: false});
			subcols.push({field:"traduction", title: "traduction", formatter: "boolFormatter", sortable: false});
			subcols.push({field:"visibleField", title: "visible", formatter: "boolFormatter", sortable: false});
			subcols.push({field:"field_type", title: "field_type", editable: false, sortable: false});
			subcols.push({field:"timezone", title: "timezone", formatter: "boolFormatter", sortable: false});
			subcols.push({field:"above", title: "Above", editable: {type: "text", mode: "inline"}, sortable: false});

			$(function () {
					buildTable($table, cols, data, true);
					// $table.bootstrapTable('load', data);
			});

			function expandTable($detail, cols, data) {
					$subtable = $detail.html('<table></table>').find('table');
					buildSubTable($subtable, cols, data, false);
			}

			function buildSubTable($el, cols, datas, detailView){

				console.log(datas);
				console.log(cols);
				$.each(cols, function(i, col){
					if(col.field == "above"){
						console.log(col.editable);
						$.each(datas, function(j, data){
							var source = [];
							var option = {};
							$.each(data.seqs, function(k, seq){
								console.log(seq.column_name);
								option.text = seq.column_name;
								option.value = seq.column_name;
								source.push(option);
							})
							col.editable.source = source;
							console.log(col.editable);
						})
					}
				})


				$el.bootstrapTable({
						columns: cols,
						// url: url,
						uniqueId: "index",
						data: datas,

						onAll: function(name, args){
			        //Fires when all events trigger, the parameters contain: name: the event name, args: the event data.
			        console.log("---------- buildSubTable: onAll -------------");
			        console.log("name=" + name);
			        console.log("args=");
			        console.log(args);
			        console.log("---------- buildSubTable: onAll -------------");
			      },

						onPreBody: function(datas){


						},

			      onEditableInit: function(){
			        //Fired when all columns was initialized by $().editable() method.
							// console.log("---------- buildSubTable: onEditableInit -------------");
							// console.log("e=");
			        // console.log(e);
			        // console.log("editable=");
			        // console.log(editable);
			        // console.log("field=");
			        // console.log(field);
			        // console.log("row=");
			        // console.log(row);
			        // console.log("oldValue=");
			        // console.log(oldValue);
			        // console.log("---------- buildSubTable: onEditableInit -------------");
			      },
			      onEditableShown: function(editable, field, row, $el){
			        //Fired when an editable cell is opened for edits.
			        // console.log("---------- buildSubTable: onEditableShown -------------");
			        // console.log("editable=");
			        // console.log(editable);
			        // console.log("field=");
			        // console.log(field);
			        // console.log("row=");
			        // console.log(row);
			        // console.log("$el=");
			        // console.log($el);
			        // console.log("---------- buildSubTable: onEditableShown -------------");
			      },
			      onEditableHidden: function(field, row, $el, reason){
			        //Fired when an editable cell is hidden / closed.
							// console.log("---------- buildSubTable: onEditableHidden -------------");
			        // console.log("editable=");
			        // console.log(editable);
			        // console.log("field=");
			        // console.log(field);
			        // console.log("row=");
			        // console.log(row);
			        // console.log("oldValue=");
			        // console.log(oldValue);
			        // console.log("---------- buildSubTable: onEditableHidden -------------");
			      },
			      onEditableSave: function (field, row, oldValue, editable) {
			        //Fired when an editable cell is saved.
			        // console.log("---------- buildSubTable: onEditableSave -------------");
			        // console.log("editable=");
			        // console.log(editable);
			        // console.log("field=");
			        // console.log(field);
			        // console.log("row=");
			        // console.log(row);
			        // console.log("oldValue=");
			        // console.log(oldValue);
			        // console.log("---------- buildSubTable: onEditableSave -------------");
			      },

						onResetView: function(){
							var $tableRows = $el.find('tbody tr');

							$.each(datas, function(i, obj){

								console.log(obj);

								if(obj.seqs.length > 1){
									$tableRows.eq(i).find('a').eq(1).editable('destroy');
									// $tableRows.eq(i).find('a').eq(0).editable('setValue', ['VARCHAR']);

									var customFieldType = {
										type: "select",
										mode: "inline"
									};

									var source = [];
									$.each(obj.seqs, function(k, seq){
										console.log(seq.column_name);
										var option = {};
										option.text = seq.column_name;
										option.value = seq.column_name;
										source.push(option);
									})

									customFieldType.source = source;


									// customFieldType.source = dbDataType;
									$tableRows.eq(i).find('a').eq(1).editable(customFieldType);
									$tableRows.eq(i).find('a').eq(1).editable('option', 'defaultValue', '');
								}

							})

						},

						onClickCell: function (field, value, row, $element){
							if(field.match("traduction|visibleField|timezone")){
								var newValue = value == false ? true : false;

								console.log($(this).bootstrapTable("getData"));

								console.log("row.index=" + row.index);
								console.log("field=" + field);
								console.log("newValue=" + newValue);

								updateCell($el, row.index, field, newValue);

							}

							if(field.match("above")){

								// console.log(field);
								// console.log(value);
								// console.log(row);
								// console.log($element);
								//
								// var $tableRows = $el.find('tbody tr');
								// console.log($tableRows.eq(row.index).find('a').eq(0).editable);
								// console.log($el.bootstrapTable('getRowByUniqueId', row.index));
								// console.log($el.bootstrapTable('getOptions'));
								// var cols = $el.bootstrapTable('getOptions').columns[0];
								// console.log(cols);
								// var editable = cols[7].editable;
								// console.log(editable);
								//
								// var customFieldType = {
								//   type: "select",
								//   mode: "inline"
								// };
								//
								// var source = [];
								// $.each(row.seqs, function(k, seq){
								// 	console.log(seq.column_name);
								// 	var option = {};
								// 	option.text = seq.column_name;
								// 	option.value = seq.column_name;
								// 	source.push(option);
								// })
								//
								// customFieldType.source = source;
								// console.log(customFieldType);
								// $tableRows.eq(row.index).find('a').eq(0).editable('destroy');
								//
								// $tableRows.eq(row.index).find('a').eq(0).editable(customFieldType);
			          // $tableRows.eq(row.index).find('a').eq(0).editable('option', 'defaultValue', '');


							}

						}
				});

			}

			function buildTable($el, cols, data, detailView) {


					$el.bootstrapTable({
							columns: cols,
							// url: url,
							data: data,
							detailView: detailView,
							onClickCell: function (field, value, row, $element){
	 							if(field.match("visible")){
	 								var newValue = value == false ? true : false;

	 								console.log($(this).bootstrapTable("getData"));

	 								console.log("row.index=" + row.index);
	 								console.log("field=" + field);
	 								console.log("newValue=" + newValue);

									updateCell($el, row.index, field, newValue);

	 							}
							},
							onExpandRow: function (index, row, $detail) {
									console.log("++++++++++++ row.fields");
									console.log(row.relations);
									expandTable($detail, subcols, row.relations);
							}
					});
			}

			function aboveFormatter(value, row, index) {
				console.log(value);
				console.log(row);
				console.log(index);
			}


			function boolFormatter(value, row, index) {
				var icon = value == true ? 'glyphicon-check' : 'glyphicon-unchecked'
				return '<i class="glyphicon ' + icon + '"></i> ';
			}

			function indexFormatter(value, row, index) {
				row.index = index;
			  return index;
			}

			function updateCell($table, index, field, newValue){

				$table.bootstrapTable("updateCell", {
					index: index,
					field: field,
					value: newValue
				});

			}

	</script>

	<script src="js/bootstrap-editable.js"></script>
	<script src="js/bootstrap-table-editable.js"></script>
	<script src="js/bootstrap-select.min.js"></script>
	<!-- <script src="js/test0.js"></script> -->

</body>
</html>
